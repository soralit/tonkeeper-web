import{j as n,s as B,ax as be,aj as ye,aP as we,ak as E,cC as Ve,cD as Ae,at as Re,r as o,L as Ce,G as X,au as G,ao as Y,as as Z,f as K,cE as V,cF as Te,cG as Se,cH as ae,cI as Be,cJ as ce,a3 as v,a4 as Fe,cK as Me,cL as re,cM as ve,cN as _e,b as le,u as Q,cO as ue,b1 as q,cP as de,c3 as Ne,bR as Oe,cQ as pe,ch as Le,cR as me,cS as he,cT as Ie,cU as Ee,cV as De,cW as ze,cX as He,cY as $e,cZ as Pe,c_ as We,c$ as Ue,d0 as Je,d1 as Ge,d2 as Ke,N as Qe,d3 as qe,d4 as Xe,cl as fe,cm as xe,aw as Ye,d5 as Ze,O as en,d6 as nn,d7 as tn,d8 as sn,d9 as on,da as an,db as cn,dc as rn,dd as ln,de as un,df as dn,dg as pn,by as mn,dh as hn,di as fn}from"./index-z3CvngUh.js";import{u as xn,A as ee}from"./ActivityDetailsLayout-8lp4KXH7.js";import{u as jn,a as gn}from"./useSendTransfer-CQ8M9gFg.js";import{C as kn,a as bn,b as yn,c as wn,d as Vn}from"./ConfirmView-ihgnCI_i.js";import{g as ne,u as je,R as An}from"./RecipientView-SdaMDAg5.js";import{T as Rn}from"./TransitionGroup-vxI9EqGQ.js";import"./jettonService-hyWKbxlO.js";import"./tonService-784EZxnW.js";import"./UserCancelledError-WQqxL8x6.js";const Cn=({isMax:e,...s})=>{const c=jn(s.recipient,s.assetAmount,e),t=gn(s.recipient,s.assetAmount,e,c.data);return n.jsx(kn,{estimation:c,...t,...s})},Tn=B.input`
    padding: 0;
    margin: 0;
    border: none;
    outline: none;
    /* added styles */
    font-family: inherit;
    font-size: inherit;
    background: transparent;
    color: ${e=>e.theme.textPrimary};

    font-family: 'Montserrat', sans-serif;
    font-style: normal;
    font-weight: 600;

    line-height: 49px;
    text-align: right;

    -moz-appearance: textfield;

    &::-webkit-outer-spin-button,
    &::-webkit-inner-spin-button {
        -webkit-appearance: none;
    }
`,ge=be.forwardRef(({value:e,setValue:s,inputSize:c},t)=>n.jsx(Tn,{autoComplete:"off",id:"sentence",ref:t,style:{fontSize:`${c.size}px`,width:`${c.width}px`},inputMode:"decimal",type:"text",value:e,onChange:a=>{s(a.target.value)}}));ge.displayName="Sentence";const Sn=B.div`
    background: ${e=>e.theme.buttonTertiaryBackground};
    border-radius: ${e=>e.theme.cornerMedium};
    padding: 0.5rem 1rem;
    display: flex;
    gap: 0.5rem;
`,Bn=B.span`
    color: ${e=>e.theme.iconSecondary};
    display: flex;
    align-items: center;
`,te=B.img`
    border-radius: ${e=>e.theme.cornerFull};
    width: 24px;
    height: 24px;
`,se=B.div`
    display: flex;
    gap: 0.5rem;
    width: 200px;
    overflow: hidden;
`,ie=B(ye)`
    color: ${e=>e.theme.textSecondary};
    text-overflow: ellipsis;
    overflow: hidden;
`,oe=B.span`
    padding-left: 0.5rem;
    color: ${e=>e.theme.accentBlue};
    display: flex;
`,Fn=({onClose:e,jetton:s,jettons:c,setJetton:t,info:a})=>{const u=Re(),d=o.useRef(null);return o.useEffect(()=>{var l,p;d.current&&((p=(l=d.current.parentElement)==null?void 0:l.parentElement)==null||p.scrollIntoView({behavior:"smooth"}))},[d]),n.jsxs(Ce,{margin:!1,dropDown:!0,children:[n.jsx(X,{dropDown:!0,onClick:()=>{t(G.TON),e()},children:n.jsxs(Y,{children:[n.jsxs(se,{children:[n.jsx(te,{src:"https://wallet.tonkeeper.com/img/toncoin.svg"}),n.jsx(E,{children:G.TON}),n.jsx(ie,{children:u((a==null?void 0:a.balance)??0)})]}),G.TON===s?n.jsx(oe,{children:n.jsx(Z,{})}):void 0]})}),c.balances.map(l=>n.jsx(X,{dropDown:!0,onClick:()=>{t(l.jetton.address),e()},children:n.jsxs(Y,{children:[n.jsxs(se,{children:[n.jsx(te,{src:l.jetton.image}),n.jsx(E,{children:l.jetton.symbol}),n.jsx(ie,{children:u(l.balance,l.jetton.decimals)})]}),l.jetton.address===s?n.jsx(oe,{ref:d,children:n.jsx(Z,{})}):void 0]})},l.jetton.address))]})},Mn=({jetton:e,jettons:s,setJetton:c,info:t})=>n.jsx(we,{center:!0,payload:a=>n.jsx(Fn,{info:t,onClose:a,jetton:e,jettons:s,setJetton:c}),children:n.jsxs(Sn,{children:[n.jsx(E,{children:Ve(e,s)}),n.jsx(Bn,{children:n.jsx(Ae,{})})]})}),vn=(e,s)=>{const{ios:c,standalone:t}=K();o.useEffect(()=>{if(!c)return;const a=window.innerHeight;function u(){const p=e.current;if(!p)return;const h=a-this.height+16,b=t?Math.max(32,h):h;p.style.bottom=`${b}px`;const A=Math.min(this.height-16-56-16-36-16-16-16-16-37,272);s.current&&(s.current.style.height=`${A}px`)}function d(){const p=window.visualViewport;p&&p.removeEventListener("resize",u),setTimeout(()=>{const h=e.current;h&&(h.style.bottom=null)})}const l=window.visualViewport;return l&&(setTimeout(()=>u.call(l),300),l.addEventListener("resize",u)),()=>{d()}},[e.current,s.current])},ke={size:40,width:30},_n=(e,s)=>{const c=s.clientWidth;let t=ke.size,a=ne(e,`600 ${t}px 'Montserrat'`);for(;Math.round(a)>c-115;)t=Math.max(1,t-1),a=ne(e,`600 ${t}px 'Montserrat'`);return{width:Math.max(Math.round(a)+5,e.length*6,30),size:t}},Nn=(e,s)=>{o.useEffect(()=>{const c=setTimeout(()=>{e.current&&e.current.focus()},300);return()=>{clearTimeout(c)}},[e.current,s])};function I(e){return e.toFormat({groupSeparator:ve(),decimalSeparator:_e()})}const On=(e,s)=>{var a;const{kind:c,payload:t}=s;switch(c){case"select":return{inputValue:"0",coinValue:new V(0),token:t.token,inFiat:!1,isMax:!1};case"max":if(t.prices!==void 0){const u=t.value.multipliedBy(t.prices).decimalPlaces(2,V.ROUND_FLOOR);return{...e,inputValue:I(e.inFiat?u:t.value),fiatValue:u,coinValue:t.value,isMax:!e.isMax}}else return{...e,inputValue:I(t.value),coinValue:t.value,isMax:!e.isMax};case"input":{const u=e.inFiat?2:e.token.decimals;let d=Te(t.value);Se(d,u)||(d=e.inputValue),ae(d)&&(d=Be(d));const l=ce(d),p=e.inFiat?l.div(t.prices??0):l,h=e.inFiat?l:l.multipliedBy(t.prices??0);return{...e,inputValue:d,coinValue:p,fiatValue:h,isMax:!1}}case"price":{if(!t.prices)return e;const u=e.coinValue.multipliedBy(t.prices).decimalPlaces(2,V.ROUND_FLOOR);return{...e,fiatValue:u}}case"toggle":{const u=I(e.inFiat?e.coinValue.decimalPlaces(e.token.decimals,V.ROUND_FLOOR):((a=e.fiatValue)==null?void 0:a.decimalPlaces(2,V.ROUND_FLOOR))??new V(0));return{...e,inputValue:u,inFiat:!e.inFiat}}default:return e}},Ln=(e,s)=>{const c=(e==null?void 0:e.inFiat)??!1;return{inputValue:(e==null?void 0:e.inputValue)??I((c?e==null?void 0:e.fiatValue:e==null?void 0:e.coinValue)||new V(0)),coinValue:(e==null?void 0:e.coinValue)??new V(0),fiatValue:e==null?void 0:e.fiatValue,token:(e==null?void 0:e.token)||(s===v.TON?Fe:Me),inFiat:c,isMax:(e==null?void 0:e.isMax)??!1}},In=e=>e.token.blockchain===v.TRON?e.token.symbol:re(e.token,{userFriendly:!0}),En=({recipient:e,onClose:s,onBack:c,onConfirm:t,defaults:a,MainButton:u,HeaderBlock:d,isAnimationProcess:l})=>{const{t:p}=le(),h=Q(),{standalone:b,fiat:A}=K(),g=e.address.blockchain,R=ue()&&l,{data:C}=q(),w=de(C),{data:D}=Ne(),[i,m]=o.useReducer(On,Ln(a,g)),{data:f,isLoading:z}=Oe(In(i)),{data:M,isLoading:_}=xn(i.token),N=o.useRef(null),T=o.useRef(null),O=o.useRef(null);vn(O,T),Nn(N,i.token);const[H,$]=o.useState(ke);o.useLayoutEffect(()=>{T.current&&$(_n(i.inputValue,T.current))},[T.current,i.inputValue]),o.useEffect(()=>{m({kind:"price",payload:{prices:f==null?void 0:f.prices}})},[m,f]);const P=o.useCallback(()=>{m({kind:"toggle",payload:void 0})},[]),W=o.useCallback(k=>{m({kind:"input",payload:{value:k,prices:f==null?void 0:f.prices}})},[m,f]),U=o.useCallback(()=>{m({kind:"max",payload:{value:M.relativeAmount,prices:f==null?void 0:f.prices}})},[m,M,f]),J=o.useCallback(k=>{m({kind:"select",payload:{token:pe(k,w)}})},[m,w]),L=M.relativeAmount.minus(i.coinValue),F=L.gte(0),r=o.useMemo(()=>F&&ae(i.inputValue)&&ce(i.inputValue).isGreaterThan(0),[F,i.inputValue]),x=o.useCallback(()=>{c(i)},[c,i]),j=o.useCallback(()=>{r?t(i):h.hapticNotification("error")},[r,t,i,h]),S=async k=>{k.stopPropagation(),k.preventDefault(),j()};return n.jsxs(Le,{onSubmit:S,standalone:b,children:[!R&&n.jsx(me,{children:n.jsx(he,{children:n.jsx(d,{onClose:s,onBack:x,children:n.jsxs(Ie,{children:[p("send_screen_steps_done_to").replace("%{name}",""),n.jsx(Ee,{recipient:e}),n.jsx(De,{recipient:e})]})})})}),n.jsxs(ze,{ref:T,children:[n.jsx(He,{children:g===v.TON?n.jsx(Mn,{info:D,jetton:re(i.token),setJetton:J,jettons:w}):n.jsx($e,{children:n.jsx(E,{children:"TRC20"})})}),n.jsxs(Pe,{children:[n.jsx(ge,{ref:N,value:i.inputValue,setValue:W,inputSize:H}),n.jsx(We,{children:i.inFiat?A:i.token.symbol})]}),n.jsx(Ue,{amountState:i,toggleFiat:P})]}),n.jsxs(Je,{children:[n.jsx(Ge,{maxValue:i.isMax,onClick:U,children:p("send_screen_steps_amount_max")}),F?n.jsxs(Ke,{children:[p("send_screen_steps_amount_remaining").replace("%{amount}",Qe.format(L,{decimals:i.token.decimals}))," ",i.token.symbol]}):n.jsx(qe,{children:p("send_screen_steps_amount_insufficient_balance")})]}),n.jsx(Xe,{}),!R&&n.jsx(fe,{children:n.jsx(xe,{children:n.jsx(u,{ref:O,isDisabled:!r,isLoading:z||_,onClick:j})})})]})},Dn=({onClose:e,chain:s,initRecipient:c,initAmountState:t})=>{const a=Q(),{standalone:u,ios:d,extension:l}=K(),{t:p}=le(),{data:h}=q(),b=de(h),A=ue(),[g,y]=o.useState("recipient"),[R,C]=o.useState(!0),[w,D]=o.useState(c),[i,m]=o.useState(t),{data:f}=Ze(),{mutateAsync:z,isLoading:M}=je(),_=r=>{var x,j;(x=i==null?void 0:i.token)!=null&&x.blockchain&&((j=i==null?void 0:i.token)==null?void 0:j.blockchain)!==r.address.blockchain&&m(void 0),D(r),f&&r.address.blockchain===v.TRON&&m({token:fn(f.balances[0])})},N=r=>{C(!0),_(r),y("amount")},T=r=>{C(!0),m(r),y("confirm")},O=r=>{C(!1),m(r),y("recipient")},H=()=>{d&&mn("decimal"),C(!1),y("amount")},$=async({address:r,text:x})=>{const j={address:r,blockchain:v.TON},S=await z(j),k=S.memoRequired?!!(S.memoRequired&&x):!0;_({address:j,toAccount:S,comment:x??"",done:k}),k&&y("amount")},P=o.useCallback(async({amount:r,jetton:x})=>{if(x){let j;try{j=pe(x,b)}catch{return a.uiEvents.emit("copy",{method:"copy",params:p("Unexpected_QR_Code")}),!1}const S=new ee({asset:j,weiAmount:r||"0"});m({coinValue:S.relativeAmount,token:j,inFiat:!1,isMax:!1})}else m({coinValue:r?en(r):new V("0"),token:t==null?void 0:t.token,inFiat:!1,isMax:!1});return!0},[a,b,t==null?void 0:t.token]),W=async r=>{const x=hn({url:r});if(x){await P(x)&&await $(x);return}return a.uiEvents.emit("copy",{method:"copy",params:p("Unexpected_QR_Code")})},U=o.useRef(null),J=o.useRef(null),L=o.useRef(null),F={recipient:U,amount:J,confirm:L}[g];return n.jsx(nn,{standalone:u,extension:l,children:n.jsx(Rn,{childFactory:tn(R),children:n.jsx(sn,{nodeRef:F,classNames:"right-to-left",addEndListener:r=>{setTimeout(r,on)},children:r=>n.jsxs("div",{ref:F,children:[g==="recipient"&&n.jsx(An,{data:w,setRecipient:N,onScan:W,keyboard:"decimal",isExternalLoading:M,acceptBlockchains:s?[s]:void 0,MainButton:an,HeaderBlock:()=>n.jsx(cn,{title:p("transaction_recipient"),onClose:e}),isAnimationProcess:r==="exiting"}),g==="amount"&&n.jsx(En,{defaults:i,onClose:e,onBack:O,recipient:w,onConfirm:T,MainButton:rn,HeaderBlock:ln,isAnimationProcess:r==="exiting"}),g==="confirm"&&n.jsxs(Cn,{onClose:e,onBack:H,recipient:w,assetAmount:ee.fromRelativeAmount({asset:i.token,amount:i.coinValue}),isMax:i.isMax,children:[r!=="exiting"&&A&&n.jsx(bn,{children:n.jsx(me,{children:n.jsx(he,{children:n.jsx(yn,{})})})}),r!=="exiting"&&A&&n.jsx(wn,{children:n.jsx(fe,{children:n.jsx(xe,{children:n.jsx(Vn,{MainButton:un})})})})]})]})},g)})})},Qn=()=>{const[e,s]=o.useState(!1),[c,t]=o.useState(void 0),[a,u]=o.useState(void 0),{data:d}=q(),{mutateAsync:l,reset:p}=je(),h=Q();o.useEffect(()=>{const g=y=>{p();const{transfer:R,asset:C}=y.params;t(y.params.chain),R?l({address:R.address}).then(w=>{u(dn(R,w,d)),s(!0)}):(u(pn(C,d)),s(!0))};return h.uiEvents.on("transfer",g),()=>{h.uiEvents.off("transfer",g)}},[d]);const b=o.useCallback(()=>{u(void 0),s(!1)},[]),A=o.useCallback(()=>{if(e)return n.jsx(Dn,{onClose:b,chain:c,initAmountState:a==null?void 0:a.initAmountState,initRecipient:a==null?void 0:a.initRecipient})},[e,a,c]);return n.jsx(Ye,{isOpen:e,handleClose:b,hideButton:!0,backShadow:!0,footer:n.jsx(n.Fragment,{}),children:A})};export{Qn as default};
