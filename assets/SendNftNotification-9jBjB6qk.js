import{j as t,dI as G,dJ as P,dR as K,dS as q,b as k,u as w,a8 as N,L as I,G as v,J as S,ao as E,dT as L,ak as M,aq as V,a4 as Q,f as y,r as u,ch as J,d4 as U,d as b,a9 as z,dk as _,Q as X,dl as Y,aa as Z,a as F,cp as $,cq as tt,a1 as et,dn as st,aw as nt,a3 as D,d6 as at,d7 as ot,d8 as it,d9 as ct,da as rt,db as lt,de as dt,dh as ut}from"./index-z3CvngUh.js";import{i as ft,I as mt,j as pt,k as ht,S as xt,T as kt,l as wt,h as jt,m as Ct,d as yt}from"./ConfirmView-ihgnCI_i.js";import{u as Tt,R as At}from"./RecipientView-SdaMDAg5.js";import{h as Bt,i as St}from"./jettonService-hyWKbxlO.js";import{A as H}from"./ActivityDetailsLayout-8lp4KXH7.js";import{T as Nt}from"./TransitionGroup-vxI9EqGQ.js";import"./UserCancelledError-WQqxL8x6.js";const Rt=({onBack:s,onClose:e})=>t.jsxs(G,{children:[t.jsx(P,{onClick:s,children:t.jsx(K,{})}),t.jsx(q,{handleClose:e})]}),gt=({nftItem:s})=>{const{t:e}=k(),n=w(),a=N();return t.jsxs(I,{fullWidth:!0,children:[s.collection&&t.jsx(v,{onClick:()=>n.copyToClipboard(S(s.collection.address,a.network,!0)),children:t.jsxs(E,{children:[t.jsx(L,{children:e("NFT_collection_id")}),t.jsx(M,{children:V(S(s.collection.address,a.network,!0))})]})}),t.jsx(v,{onClick:()=>n.copyToClipboard(S(s.address,a.network,!0)),children:t.jsxs(E,{children:[t.jsx(L,{children:e("NFT_item_id")}),t.jsx(M,{children:V(S(s.address,a.network,!0))})]})})]})},bt=new H({asset:Q,weiAmount:0}),_t=(s,e)=>{const{t:n}=k(),a=w(),{api:c}=y(),r=N(),o=b();return z([X.estimate,e==null?void 0:e.address],async()=>{try{const i=await Bt(c,r,e,s);return{fee:new H({asset:Q,weiAmount:i.event.extra*-1}),payload:i}}catch(i){throw await _(o,a,n,i),i}},{enabled:e!=null})},vt=(s,e,n)=>{const{t:a}=k(),c=w(),{api:r}=y(),o=N(),i=b(),h=Y(),{mutateAsync:p}=Z();return F(async()=>{if(!n)return!1;const l=await $(c,o.publicKey,p).catch(()=>null);if((l==null?void 0:l.type)!=="cell")throw new tt(a("ledger_operation_not_supported"));if(l===null)return!1;h("send-nft");try{await St(r,o,s,e,n,l)}catch(f){await _(i,c,a,f)}return await i.invalidateQueries([o.active.rawAddress]),await i.invalidateQueries(),!0})},Et=({recipient:s,onClose:e,nftItem:n,HeaderBlock:a,MainButton:c})=>{var x,j;const{standalone:r}=y(),[o,i]=u.useState(!1),{t:h}=k(),p=_t(n,s),{mutateAsync:l,isLoading:f,error:T,reset:R}=vt(s,n,(x=p.data)==null?void 0:x.payload),A=(j=n.previews)==null?void 0:j.find(d=>d.resolution==="100x100"),B=async()=>{if(f)return!1;try{R();const d=await l();return d&&(i(!0),setTimeout(e,2e3)),d}catch(d){return console.error(d),!1}},g=async d=>{d.stopPropagation(),d.preventDefault(),B()};return t.jsx(ft.Provider,{value:{recipient:s,assetAmount:bt,estimation:p,formState:{done:o,isLoading:f,error:T},onClose:()=>e(),onBack:()=>{},handleSubmit:B},children:t.jsxs(J,{onSubmit:g,standalone:r,children:[t.jsx(a,{}),t.jsxs(mt,{children:[A?t.jsx(pt,{src:A.url}):t.jsx(ht,{}),t.jsx(xt,{children:n.dns??n.metadata.name}),t.jsx(kt,{children:h("txActions_signRaw_types_nftItemTransfer")})]}),t.jsxs(I,{margin:!1,fullWidth:!0,children:[t.jsx(wt,{}),t.jsx(jt,{}),t.jsx(Ct,{})]}),t.jsx(gt,{nftItem:n}),t.jsx(U,{}),t.jsx(c,{})]})})},Lt=()=>{const s=w(),{api:e}=y(),n=N(),{t:a}=k(),c=b();return F(async()=>{const r=await new et(e.tonApiV2).getAccount({accountId:n.active.rawAddress});try{st(r)}catch(o){await _(c,s,a,o)}})},Mt=({nftItem:s,onClose:e})=>{const n=w(),{t:a}=k(),{standalone:c,extension:r}=y(),o=u.useRef(null),i=u.useRef(null),[h,p]=u.useState(!0),[l,f]=u.useState(),{mutateAsync:T}=Tt(),{mutateAsync:R,isLoading:A}=Lt(),B=async m=>{await R(),p(!0),f(m)},g=u.useCallback(()=>{p(!1),f(m=>m?{...m,done:!1}:void 0)},[f]),[x,j]=!l||!l.done?["recipient",o]:["confirm",i],d=u.useCallback(async({address:m})=>{const C={address:m},W=await T(C);f({address:{...C,blockchain:D.TON},toAccount:W,comment:"",done:!0})},[f,T]),O=async m=>{const C=ut({url:m});if(C===null)return n.uiEvents.emit("copy",{method:"copy",params:a("Unexpected_QR_Code")});await d(C)};return t.jsx(at,{standalone:c,extension:r,children:t.jsx(Nt,{childFactory:ot(h),children:t.jsx(it,{nodeRef:j,classNames:"right-to-left",addEndListener:m=>{setTimeout(m,ct)},children:t.jsxs("div",{ref:j,children:[x==="recipient"&&t.jsx(At,{data:l,setRecipient:B,onScan:O,isExternalLoading:A,acceptBlockchains:[D.TON],MainButton:rt,HeaderBlock:()=>t.jsx(lt,{title:a("nft_transfer_title"),onClose:e})}),x==="confirm"&&t.jsx(Et,{onClose:e,recipient:l,nftItem:s,MainButton:()=>t.jsx(yt,{MainButton:dt}),HeaderBlock:()=>t.jsx(Rt,{onBack:g,onClose:e})})]})},x)})})},Wt=()=>{const s=w(),[e,n]=u.useState(),a=u.useCallback(()=>{n(void 0)},[n]);u.useEffect(()=>{const r=o=>{n(o.params)};return s.uiEvents.on("transferNft",r),()=>{s.uiEvents.off("transferNft",r)}},[]);const c=u.useCallback(()=>{if(e)return t.jsx(Mt,{onClose:a,nftItem:e})},[e,a]);return t.jsx(nt,{isOpen:!!e,handleClose:a,hideButton:!0,backShadow:!0,children:c})};export{Wt as default};
